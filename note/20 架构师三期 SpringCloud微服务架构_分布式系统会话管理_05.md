# 会话管理

## Token安全防御

### 注意安全！

- XSS重放攻击
- CSRF跨域攻击

### Token携带方式

#### 浏览器

- http header，js可以读到header里面的token  
- url上的Get请求，也可以 
- Cookies，也可以
- localStorage，也可以  

hash(url + 时间戳 + token + 盐) = hmac. 加盐是为了防家贼
一个token只让用一次行不行？
实现方式：下发的token用一次就立即放到缓存里，相当于放入黑名单，下次再来就不行了，再次下发一个新的token。但是这样还是防不住
xss攻击，因为有浏览器可能先拿到了token再执行非法js，这时候非法js就有可能带上token了。js和token谁先被加载到了， js可以每晚，一直等token。
可以尝试把过期时间设置的短一点，能有一点作用。可以加入人机交互。  
读请求可能也不安全，不跨域：<script src="地址/base64(资源)">，这样对于小文件可以，但是大文件不行， 因为Get的URL有最大长度限制，提交多次太累。

结论就是：只要token下发到浏览器就不安全。那应该如何防治非法js进入到我们的系统里呢？那就得在提交的时候校验、转义，URLEncode %20。这个能防
web用户，家贼的话要定期扫描服务器的静态资源、数据库里的表字段，尤其是类似<script scr="...">的。敏感资源就要图形、手机验证码（上面说的人机交互）
防止xss攻击。

放哪都不安全（问题在于杜晨加密不好使）

#### APP

与浏览器差不多，首次登录之后下发token，存在本地存储

- 本地存储（在APP里随便写一个地方，手机安全区域、文本文件，每次都带着这个token去发请求）

- 前后端签名，私钥存储

苹果商店上线app，请求的接口的token为了防止被拦截，就必须是https的。苹果商店上前请求的API如果不是https的就上线不了。
这里有没有机会进行重放攻击呢？没有，APP基本没有xss攻击，除非加载webview，webview最好过一下本地代理，在代理方法里过滤一下无效请求。
手机如果粤语活着root了，就有可能丢token，所有的请求走代理服务器，代理软件就把token 信息上报上去。偷到token之后只要伪造一个模拟用户的App，
把token填写进去，就能够模拟这个用户了。这样可以token和IP绑定（对于安全级别比较高的，换了IP就重新登录，对于同一局域网的偷盗者无效）。
手机唯一标识也不行，也能被冒用。但是可以做App代码混淆，有专门的工具，混淆之后是无法反编译的（加壳、盐，但是也能跑，加壳是可逆的，
否则程序无法执行）。安全起见，还可以转移责任，短信验证码什么的，提示用户不要在不安全的网络下做某些操作、敏感信息人机交互。  

假的app被用户装上了，怎么防？做自定义的协议，动态验证。更高安全级别的，比如公安系统，还可以做物理隔离，做大局域网，这套系统只能在其中使用，
这就隔绝了外部的非法请求，但是还是要防家贼还要有制度。U盾是随机验证码，多层私钥加密


### **HMAC**

数据在传输过程中对数据产生的摘要，用于传输防篡改  
hash(url + 时间戳 + token + 盐) = hmac. 加盐是为了防家贼


## SAML 2.0

![img](images/5.jpg)

### 角色

#### Service Provider

资源/服务提供者

### Identity Provider

认证服务

## CAS

集中式身份验 Central Authentication Service